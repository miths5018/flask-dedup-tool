<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>TXT å»é‡å·¥å…·</title>
<style>
html, body {
  margin:0;
  padding:0;
  font-family:Arial,sans-serif;
  height:100%;
  color:#fff;
  overflow:hidden; /* èƒŒæ™¯å›ºå®š */
}
body {
  display:flex;
  justify-content:flex-start;
}

/* ===== èƒŒæ™¯åŠ¨ç”» ===== */
.bg-container {
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:url('{{ bg_url }}?t={{ timestamp }}') no-repeat center center;
  background-size:cover;
  z-index:-999;
  animation:floatBG 60s linear infinite alternate;
}
@keyframes floatBG {
  0%{transform:translate(0,0) scale(1);}
  25%{transform:translate(-1vw,0.5vh) scale(1.01);}
  50%{transform:translate(-2vw,1vh) scale(1.02);}
  75%{transform:translate(-1vw,0.5vh) scale(1.01);}
  100%{transform:translate(0,0) scale(1);}
}

/* ===== ä¸»å®¹å™¨å¯æ»šåŠ¨ ===== */
.container {
  display:flex;
  flex-direction:column;
  justify-content:flex-start;
  padding:4vh 4vw;
  background:rgba(0,0,0,0.55);
  border-radius:20px;
  border:1px solid rgba(255,255,255,0.15);
  backdrop-filter:blur(8px);
  box-shadow:0 8px 25px rgba(0,0,0,0.6);
  position:absolute;
  left:0;
  width:40%;
  min-width:300px;
  max-width:40%;
  z-index:10;
  overflow-y:auto;        /* âœ… å…è®¸å‚ç›´æ»šåŠ¨ */
  max-height:90vh;       /* âœ… é™åˆ¶é«˜åº¦ä¸è¶…å‡ºå±å¹• */
  scroll-behavior:smooth; /* å¹³æ»‘æ»šåŠ¨ */
}

/* ===== æ ‡é¢˜ä¸ç‰¹æ•ˆ ===== */
.container h1 {
  margin:0 0 3vh;
  font-size:clamp(32px,5vw,60px);
  color:#fff;
  text-shadow:2px 2px 6px rgba(0,0,0,0.7);
  border-bottom:3px solid #ffd700;
  padding-bottom:1vh;
  position:relative;
  animation:glow 3s ease-in-out infinite;
}
@keyframes glow {
  0%,100%{border-color:rgba(255,215,0,0.4);}
  50%{border-color:rgba(255,215,0,1);}
}

/* ===== æ¯ä¸ªæ¨¡å— ===== */
.section {
  background:rgba(255,255,255,0.1);
  border-radius:12px;
  box-shadow:0 0 12px rgba(0,0,0,0.4);
  padding:2.5vh;
  display:flex;
  flex-direction:column;
  gap:2vh;
  transition:transform 0.2s ease;
  margin-bottom:20px;
}
.section:hover { transform:translateY(-2px); }

h2 { color:#ffd700; text-shadow:1px 1px 2px #000; margin:0; font-size:clamp(22px,3vw,40px); }
input[type="file"], button {
  width:100%;
  box-sizing:border-box;
  font-size:clamp(16px,1.8vw,22px);
  padding:clamp(8px,1.5vh,14px);
  border-radius:6px;
  border:none;
}
button {
  background:linear-gradient(45deg,#ff7f50,#ff4500);
  color:#fff;
  cursor:pointer;
  transition:0.3s;
  font-weight:bold;
  border:2px solid transparent;
  animation:pulse 3s infinite;
}
button:hover { background:linear-gradient(45deg,#ff4500,#ff7f50); transform:scale(1.05); }
@keyframes pulse {
  0%{border-color:rgba(255,215,0,0.2); box-shadow:0 0 5px rgba(255,215,0,0.3);}
  50%{border-color:rgba(255,215,0,0.9); box-shadow:0 0 15px rgba(255,215,0,0.6);}
  100%{border-color:rgba(255,215,0,0.2); box-shadow:0 0 5px rgba(255,215,0,0.3);}
}

p { margin:0; font-size:clamp(16px,2vw,22px); }
#downloadBtn,#downloadABtn,#downloadBBtn,#downloadUsernameBtn {
  display:none;
  background:linear-gradient(45deg,#32cd32,#228b22);
}

/* ===== è¿›åº¦æ¡æ ·å¼ ===== */
.progress-container {
  width:100%;
  background:rgba(255,255,255,0.15);
  border-radius:5px;
  overflow:hidden;
  margin-top:5px;
}
.progress-bar {
  display:none;
  height:20px;
  background:linear-gradient(90deg,#32cd32,#228b22);
  text-align:center;
  color:#fff;
  font-size:14px;
  border-radius:5px;
  transition:width 0.3s ease;
}
.info { margin-top:5px; }
</style>
</head>

<body>
<div class="bg-container"></div>
<div class="container">
<h1>ğŸ“‚ TXT å»é‡å·¥å…·</h1>

<!-- ä¸Šä¼ èƒŒæ™¯ -->
<div class="section">
<h2>ğŸ¨ ä¸Šä¼ è‡ªå®šä¹‰èƒŒæ™¯å›¾</h2>
<form action="/upload_bg" method="post" enctype="multipart/form-data">
<input type="file" name="bg_file" accept="image/*" required>
<button type="submit">ä¸Šä¼ èƒŒæ™¯</button>
</form>
</div>

<!-- å¤šæ–‡ä»¶åˆå¹¶å»é‡ -->
<div class="section">
<h2>1ï¸âƒ£ å¤šæ–‡ä»¶åˆå¹¶å»é‡</h2>
<form id="mergeForm" action="/merge" method="post" enctype="multipart/form-data">
<input type="file" name="files" multiple required>
<button type="submit">ä¸Šä¼ å¹¶åˆå¹¶å»é‡</button>
</form>
<div class="progress-container"><div class="progress-bar" id="mergeProgress">0%</div></div>
<div class="info" id="mergeInfo"></div>
<button id="downloadBtn">â¬‡ï¸ ä¸‹è½½ç»“æœ</button>
</div>

<!-- Aã€B æ–‡ä»¶å¯¹æ¯”å»é‡ -->
<div class="section">
<h2>2ï¸âƒ£ Aã€B æ–‡ä»¶å¯¹æ¯”å»é‡</h2>
<form id="compareForm" action="/compare" method="post" enctype="multipart/form-data">
<p>æ–‡ä»¶ A: <input type="file" name="file_a" required></p>
<p>æ–‡ä»¶ B: <input type="file" name="file_b" required></p>
<button type="submit">ä¸Šä¼ å¹¶å¯¹æ¯”å»é‡</button>
</form>
<div class="progress-container"><div class="progress-bar" id="compareProgress">0%</div></div>
<div class="info" id="compareInfo"></div>
<div style="display:flex; gap:10px; margin-top:10px;">
<button id="downloadABtn">â¬‡ï¸ ä¸‹è½½ A ç»“æœ</button>
<button id="downloadBBtn">â¬‡ï¸ ä¸‹è½½ B ç»“æœ</button>
</div>
</div>

<!-- å•æ–‡ä»¶ç”¨æˆ·åå»é‡ -->
<div class="section">
<h2>3ï¸âƒ£ å•æ–‡ä»¶ç”¨æˆ·åå»é‡</h2>
<form id="usernameForm" action="/username_dedup" method="post" enctype="multipart/form-data">
<input type="file" name="username_file" required>
<button type="submit">ä¸Šä¼ å¹¶å»é‡</button>
</form>
<div class="progress-container"><div class="progress-bar" id="usernameProgress">0%</div></div>
<div class="info" id="usernameInfo"></div>
<button id="downloadUsernameBtn">â¬‡ï¸ ä¸‹è½½å»é‡ç»“æœ</button>
</div>
</div>

<script>
// ====================== çŠ¶æ€è½®è¯¢ ======================
function pollDownload(taskId, btnId, info){
    const btn = document.getElementById(btnId);
    const interval = setInterval(()=>{
        fetch(`/status/${taskId}`)
        .then(res=>res.json())
        .then(data=>{
            if(data.status==="ready"){
                clearInterval(interval);
                if(data.download_url_a && data.download_url_b){
                    info.textContent=`âœ… å»é‡å®Œæˆï¼ŒA æ–‡ä»¶ï¼š${data.count_a} æ¡ï¼ŒB æ–‡ä»¶ï¼š${data.count_b} æ¡`;
                    document.getElementById('downloadABtn').style.display='block';
                    document.getElementById('downloadBBtn').style.display='block';
                    document.getElementById('downloadABtn').onclick=()=>{window.location.href=data.download_url_a;setTimeout(()=>location.reload(),1000);};
                    document.getElementById('downloadBBtn').onclick=()=>{window.location.href=data.download_url_b;setTimeout(()=>location.reload(),1000);};
                } else {
                    info.textContent=`âœ… å»é‡å®Œæˆï¼Œæ¡æ•°ï¼š${data.count}`;
                    btn.style.display='block';
                    btn.onclick=()=>{window.location.href=data.download_url;setTimeout(()=>location.reload(),1000);};
                }
            } else if(data.status==="processing"){
                info.textContent="â³ æ–‡ä»¶å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...";
            } else {
                info.textContent=`âŒ ${data.message}`;
                clearInterval(interval);
            }
        })
        .catch(()=>{info.textContent="âŒ çŠ¶æ€è·å–å¤±è´¥"; clearInterval(interval);});
    },1500);
}

// ====================== ä¸Šä¼ ä¸è¿›åº¦æ¡ ======================
function uploadWithPolling(formId, progressId, infoId, btnId){
    const form=document.getElementById(formId);
    const progress=document.getElementById(progressId);
    const info=document.getElementById(infoId);

    form.addEventListener('submit', function(e){
        e.preventDefault();
        const formData=new FormData(form);
        const xhr=new XMLHttpRequest();

        progress.style.display='block';
        progress.style.width='0%';
        progress.textContent='0%';
        info.textContent='â³ æ­£åœ¨ä¸Šä¼ ...';

        xhr.upload.onprogress=function(e){
            if(e.lengthComputable){
                const percent=Math.round((e.loaded/e.total)*100);
                progress.style.width=percent+'%';
                progress.textContent=percent+'%';
            }
        };

        xhr.onload=function(){
            if(xhr.status===200){
                const res=JSON.parse(xhr.responseText);
                if(res.status==='success'){
                    info.textContent='âœ… ä¸Šä¼ å®Œæˆï¼Œå¤„ç†ä¸­...';
                    pollDownload(res.task_id, btnId, info);
                } else {
                    info.textContent='âŒ '+res.message;
                }
            } else {
                info.textContent='âŒ ä¸Šä¼ å¤±è´¥';
            }
        };

        xhr.onerror=function(){
            info.textContent='âŒ ç½‘ç»œé”™è¯¯';
        };

        xhr.open('POST', form.action, true);
        xhr.send(formData);
    });
}

uploadWithPolling('mergeForm','mergeProgress','mergeInfo','downloadBtn');
uploadWithPolling('compareForm','compareProgress','compareInfo','downloadBtn');
uploadWithPolling('usernameForm','usernameProgress','usernameInfo','downloadUsernameBtn');
</script>
</body>
</html>
